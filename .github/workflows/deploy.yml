name: Deploy Promo Align
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ./  # repo root

    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
      POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
      ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    steps:
      - uses: actions/checkout@v4

  steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Stop old containers
      run: docker compose down || true

    - name: Build web container
      run: docker compose build web

    - name: Start DB
      run: docker compose up -d db

    - name: Wait for Postgres to be ready
      run: |
        until docker exec promo_align_db pg_isready -U $POSTGRES_USER; do
          echo "Waiting for Postgres..."
          sleep 2
        done

    - name: Start web container (app)
      run: docker compose up -d web

    - name: Run migrations inside running web container
      run: |
        set -e
        docker exec promo_align_nextjs npx drizzle-kit migrate || \
        (echo "Migration failed, shutting down containers" && docker compose down && exit 1)